-- initial commands
.headers off
.separator ','

-- (a) Import data
-- [insert sql statement(s) below]
CREATE TABLE athletes(
    id integer,
    sex text,
    dob text,
    height float,
    weight integer,
    nationality text
    );
.separator ','
.import athletes.csv athletes

CREATE TABLE countries(
    country text,
    code text,
    population integer,
    gdp float
);
.import countries.csv countries

CREATE TABLE games(
    id integer,
    name text,
    nationality text,
    sport text,
    gold integer,
    silver integer,
    bronze integer
);
.import games.csv games

-- (b) Build indexes
-- [insert sql statement(s) below]
CREATE INDEX id_index ON athletes(id);
CREATE INDEX nationality_index ON athletes(nationality);
CREATE INDEX id_games_index ON games(id);
CREATE INDEX code_index ON countries(code);

-- (c) Quick computation.
-- [insert sql statement(s) below]


SELECT SUM(*) FROM games WHERE nationality='USA' AND gold>0;
select '';

-- (d) Distinct Sports.
-- [insert sql statement(s) below]

SELECT DISTINCT(sport) FROM games WHERE nationality='USA' AND gold>0 ORDER BY sport;
select '';

-- (e) Handling Empty Cells.
-- [insert sql statement(s) below]
.mode csv
UPDATE countries SET population = NULL where population = '';
SELECT country, SUM(gold+silver+bronze) FROM countries INNER JOIN games ON code=nationality GROUP BY country ORDER BY population DESC LIMIT 5;
.mode list
select '';

-- (f) Female Athletes.
-- [insert sql statement(s) below]
.mode csv
SELECT c.country, COUNT(g.gold) gs from countries c INNER JOIN games g 
ON c.code=g.nationality INNER JOIN athletes a on g.id = a.id 
WHERE a.sex='female' AND g.gold > 0 GROUP BY country ORDER BY gs DESC LIMIT 5;
.mode list
select '';

-- (g) Fit Athletes
-- [insert sql statement(s) below]
.mode csv
SELECT g.name, (a.weight/(a.height*a.height)) bmi FROM games g INNER JOIN athletes a ON g.id = a.id WHERE bmi >= 18.5 AND bmi <= 24.9 ORDER BY g.name, bmi DESC LIMIT 10;
.mode list
select '';

-- (h) Percentages of Gold & Silver Medals.
-- [insert sql statement(s) below]
.mode csv
SELECT c.country, CAST(SUM(g.gold)*100.0/gt AS INT) git, CAST(SUM(g.silver)*100.0/st AS INT) sit from countries c JOIN games g on c.code=g.nationality JOIN (SELECT SUM(gold) as gt, SUM(silver) as st FROM games) GROUP BY c.code ORDER BY git DESC, sit DESC LIMIT 20;
.mode list
select '';

-- (i) Creating a view.
-- [insert sql statement(s) below]

-- SELECT code, gdp FROM countries ORDER BY gdp desc;
-- SELECT code, LAG(gdp, 1, 0) OVER (ORDER BY gdp DESC) FROM countries ORDER BY gdp DESC;
.mode csv
-- CREATE VIEW gdp_metrics AS
-- SELECT country1.name as full_country1_name, country2.country as full_country2_name, country1.gross-country2.gdp as difference_gdp FROM
-- ((SELECT code, LAG(country, 1) OVER (ORDER BY gdp DESC) as name, LAG(gdp, 1) OVER (ORDER BY gdp DESC) as gross FROM countries ORDER BY gdp DESC) country1
-- JOIN (SELECT country, code, gdp FROM countries ORDER BY gdp desc) country2 
-- ON country1.code=country2.code) 
-- WHERE difference_gdp > 0 AND difference_gdp < 100;
-- SELECT * FROM gdp_metrics ORDER BY difference_gdp DESC LIMIT 5;
create view gdp_metrics as with filter as 
(select * from countries where gdp != '') 
select a.country,b.country,a.gdp-b.gdp as diff from filter a inner join filter b on a.country != b.country where diff > 0.0 and diff <= 100.0;
select * from gdp_metrics order by diff desc limit 5;
.mode list
select '';

-- (j) Count total pairs.
-- [insert sql statement(s) below]
SELECT COUNT(*) FROM gdp_metrics ORDER BY difference_gdp DESC LIMIT 5;
select '';

-- (k) Create and import data into FTS table movie_overview.
-- [insert sql statement(s) below]
CREATE VIRTUAL TABLE movie_overview USING fts4(
    id integer, 
    name text, 
    year integer, 
    overview text, 
    popularity decimal);
.separator ','
.import movie-overview.txt movie_overview

-- (k) part 1
-- [insert sql statement(s) below]

SELECT COUNT(*) from movie_overview WHERE overview MATCH '^in';
select '';

-- (k) part 2
-- [insert sql statement(s) below]

SELECT id from movie_overview WHERE overview MATCH 'love NEAR/7 city';
select '';

-- (k) part 3
-- [insert sql statement(s) below]
SELECT name from movie_overview WHERE overview MATCH 'geo*';